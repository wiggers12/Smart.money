<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Jogo de Alfabetiza√ß√£o ‚Ä¢ Plus</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#f0f9ff;
      --card:#ffffff;
      --primary:#0077b6;
      --primary-2:#00b4d8;
      --text:#0b2942;
      --muted:#6b7280;
      --good:#10b981;
      --warn:#f59e0b;
      --danger:#ef4444;
      --shadow:0 8px 30px rgba(0,0,0,.08);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text); background:linear-gradient(180deg,var(--bg),#fff);
      display:flex; flex-direction:column;
    }
    .wrap{flex:1; display:flex; flex-direction:column}
    .tela{display:none; flex:1; align-items:center; justify-content:center; padding:20px}
    .tela.ativa{display:flex}
    .container{
      width:min(980px,100%); margin:0 auto; display:flex; flex-direction:column; gap:18px;
      align-items:center; justify-content:center;
    }
    .card{
      width:100%; background:var(--card); border-radius:var(--radius); padding:22px;
      box-shadow:var(--shadow);
    }
    .center{display:flex; align-items:center; justify-content:center}
    h1,h2,h3{margin:0}
    h1{font-size:clamp(20px,4.5vw,36px)}
    h2{font-size:clamp(18px,3.5vw,28px)}
    p{margin:0; color:var(--muted)}
    /* Splash */
    #splash{
      background: radial-gradient(1200px 400px at 50% -10%, #c9f1ff 10%, transparent 60%),
                  linear-gradient(135deg, var(--primary), var(--primary-2));
      color:#fff; text-align:center; animation:fadein .8s ease;
    }
    .splash-title{font-weight:800; letter-spacing:.3px}
    .splash-sub{opacity:.9}
    .splash-actions{display:flex; gap:12px; flex-wrap:wrap; margin-top:16px}
    .logo{font-weight:900}

    /* Bot√µes */
    button{
      appearance:none; border:0; border-radius:14px; padding:14px 18px; cursor:pointer;
      background:var(--primary); color:#fff; font-weight:700; letter-spacing:.2px;
      box-shadow:0 6px 16px rgba(0,119,182,.18); transition:.2s transform,.2s box-shadow,.2s background;
    }
    button:hover{transform:translateY(-1px); background:var(--primary-2)}
    button:active{transform:translateY(0)}
    .btn-outline{background:#fff; color:var(--primary); border:2px solid var(--primary)}
    .btn-ghost{background:#f1f5f9; color:var(--text)}
    .btn-danger{background:var(--danger)}
    .btn-good{background:var(--good)}
    .btn-warn{background:var(--warn)}

    .grid{display:grid; gap:14px}
    .grid.cols-2{grid-template-columns:repeat(2,1fr)}
    .grid.cols-3{grid-template-columns:repeat(3,1fr)}
    .grid.cols-4{grid-template-columns:repeat(4,1fr)}
    @media (max-width:760px){
      .grid.cols-4{grid-template-columns:repeat(2,1fr)}
      .grid.cols-3{grid-template-columns:repeat(2,1fr)}
      .grid.cols-2{grid-template-columns:1fr}
    }

    /* Fase */
    .fase-title{display:flex; align-items:center; justify-content:space-between; gap:12px}
    .big{
      font-size:clamp(36px,10vw,70px); font-weight:900; letter-spacing:.5px; text-align:center;
      padding:20px; border-radius:16px; background:#fafcff; border:2px dashed #e2e8f0;
    }
    .sub{font-size:clamp(16px,3.2vw,22px); color:var(--muted)}
    .controls{display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:center}
    .row{display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap}
    .pill{background:#eff6ff; color:#0369a1; padding:8px 12px; border-radius:999px; font-weight:700}
    .progress{height:10px; width:100%; background:#eef2f7; border-radius:999px; overflow:hidden}
    .progress>span{display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--primary),var(--primary-2))}
    .muted{color:var(--muted)}
    .kbd{
      font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      background:#0b29420d; border:1px solid #0b294233; padding:.15rem .4rem; border-radius:6px; font-size:.9em;
    }
    .footer{opacity:.7; font-size:13px; text-align:center; padding:10px}

    /* Toggle */
    .toggle{display:inline-flex; align-items:center; gap:8px}
    .toggle input{display:none}
    .toggle .track{
      width:54px;height:28px;border-radius:999px;background:#c7d2fe; position:relative; transition:.2s;
    }
    .toggle .thumb{
      width:22px;height:22px;border-radius:50%; background:#fff; position:absolute; top:3px; left:3px; transition:.2s;
      box-shadow:0 2px 8px rgba(0,0,0,.15)
    }
    .toggle input:checked + .track{background:#34d399}
    .toggle input:checked + .track .thumb{left:29px}

    /* Focus */
    :focus-visible{outline:3px solid #93c5fd; outline-offset:2px; border-radius:12px}

    @keyframes fadein{from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:translateY(0)}}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- SPLASH -->
    <section id="splash" class="tela ativa">
      <div class="container center" style="max-width:820px">
        <div class="card" style="text-align:center; color:#0b2942; background:rgba(255,255,255,.14); backdrop-filter: blur(6px);">
          <h1 class="splash-title logo">üéâ Jogo de Alfabetiza√ß√£o</h1>
          <p class="splash-sub" style="margin-top:8px">Letras, vogais, consoantes e s√≠labas com narra√ß√£o brasileira.</p>
          <div class="splash-actions">
            <button id="btnAtivarAudio" class="btn-good" aria-label="Ativar √°udio">üîà Ativar √°udio</button>
            <button class="btn-outline" id="btnEntrar">Entrar</button>
          </div>
          <p class="footer" style="margin-top:10px">Dica: alguns navegadores s√≥ liberam a voz depois do primeiro clique em ‚ÄúAtivar √°udio‚Äù.</p>
        </div>
      </div>
    </section>

    <!-- MENU -->
    <section id="menu" class="tela">
      <div class="container" style="max-width:980px">
        <div class="card">
          <h2 style="margin-bottom:10px">Escolha uma fase</h2>
          <div class="grid cols-2" role="menu" aria-label="Modos de jogo">
            <button role="menuitem" onclick="iniciarFase('alfabeto')" aria-label="Alfabeto">üî§ Alfabeto</button>
            <button role="menuitem" onclick="iniciarFase('vogais')" aria-label="Vogais">üÖ∞Ô∏è Vogais</button>
            <button role="menuitem" onclick="iniciarFase('consoantes')" aria-label="Consoantes">üÖ±Ô∏è Consoantes</button>
            <button role="menuitem" onclick="abrirMenuSilabas()" aria-label="S√≠labas">üî° S√≠labas</button>
          </div>
        </div>

        <div class="card">
          <h3 style="margin-bottom:10px">Configura√ß√µes r√°pidas</h3>
          <div class="row">
            <label class="toggle" title="Auto-avan√ßar">
              <input type="checkbox" id="cfgAuto" />
              <span class="track"><span class="thumb"></span></span>
              <span>Auto-avan√ßar</span>
            </label>
            <label class="toggle" title="Embaralhar ordem">
              <input type="checkbox" id="cfgShuffle" />
              <span class="track"><span class="thumb"></span></span>
              <span>Embaralhar</span>
            </label>
            <label class="toggle" title="√Åudio mudo">
              <input type="checkbox" id="cfgMute" />
              <span class="track"><span class="thumb"></span></span>
              <span>Mudo</span>
            </label>
            <div class="row">
              <span class="pill">Velocidade</span>
              <input id="velocidade" type="range" min="0.6" max="1.2" step="0.1" value="0.9" aria-label="Velocidade da fala" />
              <span id="velocidadeVal" class="muted">0.9x</span>
            </div>
            <div class="row">
              <span class="pill">Voz</span>
              <select id="vozSelect" aria-label="Escolher voz"></select>
            </div>
          </div>
          <div class="footer">
            Atalhos: <span class="kbd">‚Üê</span>/<span class="kbd">‚Üí</span> anterior/pr√≥xima ‚Ä¢ <span class="kbd">Espa√ßo</span> falar ‚Ä¢ <span class="kbd">A</span> auto ‚Ä¢ <span class="kbd">M</span> mudo
          </div>
        </div>
      </div>
    </section>

    <!-- MENU S√çLABAS -->
    <section id="menuSilabas" class="tela">
      <div class="container" style="max-width:900px">
        <div class="card">
          <h2 style="margin-bottom:10px">Escolha a quantidade de s√≠labas</h2>
          <div id="listaSilabas" class="grid cols-4"></div>
          <div class="row" style="margin-top:10px">
            <button class="btn-ghost" onclick="voltarMenu()">‚¨ÖÔ∏è Voltar</button>
          </div>
        </div>
      </div>
    </section>

    <!-- FASE -->
    <section id="fase" class="tela" aria-live="polite">
      <div class="container" style="max-width:980px">
        <div class="card">
          <div class="fase-title">
            <h2 id="tituloFase">‚Äî</h2>
            <div class="pill"><span id="posAtual">0</span>/<span id="posTotal">0</span></div>
          </div>
          <div class="progress" style="margin-top:12px"><span id="barraProgresso"></span></div>
        </div>

        <div class="card center" style="gap:10px">
          <div id="pergunta" class="big" role="heading" aria-level="1">‚Äî</div>
          <div id="subtexto" class="sub">‚Äî</div>
        </div>

        <div class="card">
          <div class="controls">
            <button id="btnAnterior" class="btn-ghost" aria-label="Item anterior">‚¨ÖÔ∏è Anterior</button>
            <button id="btnFalar" aria-label="Falar novamente">üîä Falar</button>
            <button id="btnPausar" class="btn-outline" aria-label="Pausar fala">‚è∏Ô∏è Pausar</button>
            <button id="btnProxima" aria-label="Pr√≥ximo item">‚û°Ô∏è Pr√≥xima</button>
          </div>

          <div class="row" style="margin-top:10px">
            <label class="toggle" title="Auto-avan√ßar nesta fase">
              <input type="checkbox" id="faseAuto" />
              <span class="track"><span class="thumb"></span></span>
              <span>Auto-avan√ßar</span>
            </label>
            <div class="row">
              <span class="pill">Intervalo</span>
              <input id="intervalo" type="range" min="1.5" max="6" step="0.5" value="4" aria-label="Intervalo de auto-avan√ßar em segundos" />
              <span id="intervaloVal" class="muted">4.0s</span>
            </div>
            <label class="toggle" title="Embaralhar nesta fase">
              <input type="checkbox" id="faseShuffle" />
              <span class="track"><span class="thumb"></span></span>
              <span>Embaralhar</span>
            </label>
            <button class="btn-ghost" onclick="voltarMenu()">‚¨ÖÔ∏è Voltar ao menu</button>
          </div>
        </div>

        <div id="cronometroArea" class="footer"></div>
      </div>
    </section>
  </div>

  <script>
    // ========= DADOS =========
    const pronunciaLetras = {
      A:"√°", B:"b√™", C:"c√™", D:"d√™", E:"√©", F:"√©fe", G:"g√™", H:"ag√°", I:"i",
      J:"j√≥ta", K:"c√°", L:"√©le", M:"√™me", N:"√™ne", O:"√≥", P:"p√™", Q:"qu√™",
      R:"√©rre", S:"√©sse", T:"t√™", U:"u", V:"v√™", W:"d√°blio", X:"xis", Y:"√≠psilon", Z:"z√™"
    };
    const alfabeto = Array.from({length:26},(_,i)=>String.fromCharCode(65+i));
    const vogais = ["A","E","I","O","U"];
    const consoantes = alfabeto.filter(l=>!vogais.includes(l));

    // Palavras reais divididas em s√≠labas (revisadas/expandidas)
    // Obs.: aqui usamos separa√ß√µes did√°ticas simplificadas para fins de jogo
    const palavrasSilabas = {
      2: [
        {partes:["BO","LA"], palavra:"BOLA"},
        {partes:["CA","SA"], palavra:"CASA"},
        {partes:["PA","TO"], palavra:"PATO"},
        {partes:["GA","TO"], palavra:"GATO"},
        {partes:["LI","VRO"], palavra:"LIVRO"}
      ],
      3: [
        {partes:["CA","DEI","RA"], palavra:"CADEIRA"},
        {partes:["JA","NE","LA"], palavra:"JANELA"},
        {partes:["SO","RVE","TE"], palavra:"SORVETE"},
        {partes:["PA","PAI","A"], palavra:"PAPAIA"}
      ],
      4: [
        {partes:["A","MA","RE","LO"], palavra:"AMARELO"},
        {partes:["MA","CA","CO","ZIN"], palavra:"MACACOZIN"}, // l√∫dico
        {partes:["TE","LE","VI","S√ÉO"], palavra:"TELEVIS√ÉO"}
      ],
      5: [
        {partes:["A","VI","A","√á√É","O"], palavra:"AVIA√á√ÉO"},
        {partes:["MA","RA","VI","LHO","SO"], palavra:"MARAVILHOSO"}
      ],
      6: [
        {partes:["HE","LI","C√ìP","TE","RI","NHO"], palavra:"HELIC√ìPTERINHO"}
      ]
    };

    // Monta √≠ndice din√¢mico dispon√≠vel no menu de s√≠labas
    const opcoesSilabas = Object.keys(palavrasSilabas).map(n=>parseInt(n,10)).sort((a,b)=>a-b);

    // ========= ESTADO =========
    const state = {
      fase:"",          // alfabeto | vogais | consoantes | silabas
      lista:[],         // itens atuais (letras ou palavras)
      indice:0,
      qtdSilabas:null,
      auto:false,
      shuffle:false,
      mute:false,
      velocidade:0.9,
      intervaloSeg:4,
      vozURI:null,
      timer:null,
      speaking:false
    };

    // ========= DOM =========
    const telas = { splash:qs("#splash"), menu:qs("#menu"), menuSilabas:qs("#menuSilabas"), fase:qs("#fase") };
    const tituloFase = qs("#tituloFase");
    const pergunta = qs("#pergunta");
    const subtexto = qs("#subtexto");
    const posAtual = qs("#posAtual");
    const posTotal = qs("#posTotal");
    const barraProgresso = qs("#barraProgresso");
    const cronometroArea = qs("#cronometroArea");

    // Controles globais
    const cfgAuto = qs("#cfgAuto");
    const cfgShuffle = qs("#cfgShuffle");
    const cfgMute = qs("#cfgMute");
    const velocidade = qs("#velocidade");
    const velocidadeVal = qs("#velocidadeVal");
    const vozSelect = qs("#vozSelect");

    // Controles de fase
    const btnAnterior = qs("#btnAnterior");
    const btnProxima = qs("#btnProxima");
    const btnFalar = qs("#btnFalar");
    const btnPausar = qs("#btnPausar");
    const faseAuto = qs("#faseAuto");
    const faseShuffle = qs("#faseShuffle");
    const intervalo = qs("#intervalo");
    const intervaloVal = qs("#intervaloVal");

    // Splash
    qs("#btnEntrar").addEventListener("click", ()=>mostrarTela("menu"));
    qs("#btnAtivarAudio").addEventListener("click", ()=> {
      // pequena fala vazia para ‚Äúdesbloquear‚Äù TTS em alguns navegadores
      falar("√Åudio ativado", 1.0, true);
    });

    // ========= INICIALIZA√á√ÉO =========
    window.addEventListener("load", ()=>{
      // Preencher menu de s√≠labas
      const listaSilabas = qs("#listaSilabas");
      listaSilabas.innerHTML = opcoesSilabas.map(n=>`<button onclick="iniciarSilabas(${n})">${n} s√≠labas</button>`).join("");
      // Carregar prefer√™ncias
      loadPrefs();
      atualizarControlesUI();
      popularVozes();
      // Atalhos
      window.addEventListener("keydown", atalhos);
      // Se j√° havia fase salva, opcionalmente poder√≠amos retomar (aqui mantemos s√≥ prefs)
    });

    function mostrarTela(id){
      document.querySelectorAll(".tela").forEach(t=>t.classList.remove("ativa"));
      telas[id].classList.add("ativa");
    }
    function abrirMenuSilabas(){ mostrarTela("menuSilabas"); }

    function voltarMenu(){
      salvarPrefs();
      stopAuto();
      speechSynthesis.cancel();
      mostrarTela("menu");
    }

    // ========= FASES =========
    function iniciarFase(nome){
      state.fase = nome;
      state.indice = 0;
      state.qtdSilabas = null;
      state.lista = (nome==="alfabeto"? [...alfabeto] :
                    nome==="vogais" ? [...vogais] :
                    nome==="consoantes" ? [...consoantes] : []);
      aplicarShuffleSeMarcado();
      configurarTitulo();
      atualizarPainel();
      mostrarTela("fase");
      tocarItemAtual();
      aplicarAutoSeMarcado();
    }

    function iniciarSilabas(qtd){
      state.fase = "silabas";
      state.indice = 0;
      state.qtdSilabas = qtd;
      state.lista = [...(palavrasSilabas[qtd] || [])];
      aplicarShuffleSeMarcado();
      configurarTitulo();
      atualizarPainel();
      mostrarTela("fase");
      tocarItemAtual();
      aplicarAutoSeMarcado();
    }

    function configurarTitulo(){
      const t = (state.fase==="alfabeto"?"üî§ Alfabeto":
                state.fase==="vogais"?"üÖ∞Ô∏è Vogais":
                state.fase==="consoantes"?"üÖ±Ô∏è Consoantes":
                state.fase==="silabas"?`üî° ${state.qtdSilabas} s√≠labas`:"‚Äî");
      tituloFase.textContent = t;
      posTotal.textContent = state.lista.length;
    }

    function atualizarPainel(){
      const total = state.lista.length||1;
      const i = state.indice;
      posAtual.textContent = Math.min(i+1,total);
      barraProgresso.style.width = `${((i)/total)*100}%`;

      if(state.fase==="silabas"){
        const item = state.lista[i];
        if(!item){ fimDeFase(); return; }
        pergunta.textContent = `${item.partes.join(" - ")} = ${item.palavra}`;
        subtexto.textContent = "Repita comigo!";
      } else {
        const letra = state.lista[i];
        if(!letra){ fimDeFase(); return; }
        pergunta.textContent = letra;
        subtexto.textContent = "Repita comigo!";
      }
    }

    function fimDeFase(){
      pergunta.textContent = "üéâ Voc√™ terminou esta fase!";
      subtexto.textContent = "";
      barraProgresso.style.width = "100%";
      if(!state.mute) falar("Parab√©ns, voc√™ completou a fase!", state.velocidade);
      stopAuto();
    }

    function anterior(){
      if(state.indice>0){ state.indice--; atualizarPainel(); tocarItemAtual(); }
    }
    function proxima(){
      if(state.indice < state.lista.length-1){ state.indice++; atualizarPainel(); tocarItemAtual(); }
      else fimDeFase();
    }

    // ========= FALA =========
    function falar(texto, velocidade=0.9, force=false){
      if(state.mute && !force) return;
      const msg = new SpeechSynthesisUtterance(texto);
      msg.lang = "pt-BR";
      msg.rate = Number(velocidade)||0.9;
      if(state.vozURI){
        const v = speechSynthesis.getVoices().find(v=>v.voiceURI===state.vozURI);
        if(v) msg.voice = v;
      }else{
        // prefer√™ncias de vozes pt-BR quando dispon√≠veis
        const prefer = speechSynthesis.getVoices().find(v=>/pt(-|_)BR/i.test(v.lang));
        if(prefer) msg.voice = prefer;
      }
      speechSynthesis.cancel();
      state.speaking = true;
      msg.onend = ()=>{ state.speaking = false; };
      speechSynthesis.speak(msg);
    }

    function tocarItemAtual(){
      if(state.fase==="silabas"){
        const item = state.lista[state.indice];
        if(!item) return;
        // 1) Letra por letra de cada s√≠laba
        let delay = 0;
        item.partes.forEach(parte=>{
          const fala = parte.split("").map(l=>pronunciaLetras[l]||l).join(" e o ");
          setTimeout(()=>falar(`${fala}, ${parte}`, state.velocidade), delay);
          delay += 2200;
        });
        // 2) S√≠labas juntas
        setTimeout(()=>falar(item.partes.join(" - "), state.velocidade), delay);
      } else {
        const letra = state.lista[state.indice];
        const nome = pronunciaLetras[letra]||letra;
        falar(`letra ${nome}`, state.velocidade);
        setTimeout(()=>falar(`letra ${nome}`, state.velocidade), 1600);
      }
    }

    // ========= AUTO =========
    function aplicarAutoSeMarcado(){
      const marcado = faseAuto.checked;
      if(!marcado){ stopAuto(); return; }
      startAuto();
    }
    function startAuto(){
      stopAuto();
      const ms = Number(intervalo.value)*1000;
      cronometro(ms);
      state.timer = setInterval(()=>{
        proxima();
        cronometro(Number(intervalo.value)*1000);
      }, ms);
    }
    function stopAuto(){
      if(state.timer){ clearInterval(state.timer); state.timer = null; }
      cronometroArea.textContent = "";
    }
    function cronometro(msTotal){
      const start = Date.now();
      function tick(){
        if(!state.timer) return;
        const rest = Math.max(0, msTotal - (Date.now()-start));
        cronometroArea.textContent = `Pr√≥ximo em ${(rest/1000).toFixed(1)}s...`;
        if(rest>0) requestAnimationFrame(tick);
      }
      tick();
    }

    // ========= CONTROLES =========
    btnAnterior.addEventListener("click", anterior);
    btnProxima.addEventListener("click", proxima);
    btnFalar.addEventListener("click", ()=>tocarItemAtual());
    btnPausar.addEventListener("click", ()=>speechSynthesis.cancel());

    faseAuto.addEventListener("change", ()=>{
      if(faseAuto.checked) startAuto(); else stopAuto();
      salvarPrefs();
    });
    intervalo.addEventListener("input", ()=>{
      intervaloVal.textContent = `${Number(intervalo.value).toFixed(1)}s`;
      if(state.timer){ startAuto(); } // reinicia com novo tempo
      salvarPrefs();
    });
    faseShuffle.addEventListener("change", ()=>{
      aplicarShuffleSeMarcado(true);
      salvarPrefs();
    });

    cfgAuto.addEventListener("change", ()=>{ salvarPrefs(); });
    cfgShuffle.addEventListener("change", ()=>{ salvarPrefs(); });
    cfgMute.addEventListener("change", ()=>{ state.mute = cfgMute.checked; salvarPrefs(); });

    velocidade.addEventListener("input", ()=>{
      state.velocidade = Number(velocidade.value);
      velocidadeVal.textContent = `${state.velocidade.toFixed(1)}x`;
      salvarPrefs();
    });

    // ========= SHUFFLE =========
    function aplicarShuffleSeMarcado(naFase=false){
      const marcado = naFase ? faseShuffle.checked : (cfgShuffle.checked || faseShuffle.checked);
      if(!marcado) return;
      shuffle(state.lista);
      state.indice = 0;
    }

    // ========= PREFER√äNCIAS =========
    function salvarPrefs(){
      const prefs = {
        autoGlobal: cfgAuto.checked,
        shuffleGlobal: cfgShuffle.checked,
        mute: cfgMute.checked,
        velocidade: Number(velocidade.value),
        vozURI: state.vozURI,
        autoFase: faseAuto.checked,
        shuffleFase: faseShuffle.checked,
        intervalo: Number(intervalo.value)
      };
      localStorage.setItem("alfabeto_prefs", JSON.stringify(prefs));
    }
    function loadPrefs(){
      try{
        const prefs = JSON.parse(localStorage.getItem("alfabeto_prefs")||"{}");
        cfgAuto.checked = !!prefs.autoGlobal;
        cfgShuffle.checked = !!prefs.shuffleGlobal;
        cfgMute.checked = !!prefs.mute;
        velocidade.value = prefs.velocidade ?? 0.9;
        velocidadeVal.textContent = `${Number(velocidade.value).toFixed(1)}x`;
        faseAuto.checked = !!prefs.autoFase;
        faseShuffle.checked = !!prefs.shuffleFase;
        intervalo.value = prefs.intervalo ?? 4;
        intervaloVal.textContent = `${Number(intervalo.value).toFixed(1)}s`;
        state.velocidade = Number(velocidade.value);
        state.mute = cfgMute.checked;
        state.vozURI = prefs.vozURI ?? null;
      }catch{}
    }
    function atualizarControlesUI(){
      // j√° sincronizados por loadPrefs
    }

    // ========= VOZES =========
    function popularVozes(){
      function fill(){
        const voices = speechSynthesis.getVoices();
        vozSelect.innerHTML = "";
        // Preferir pt-BR no topo
        const sorted = [...voices].sort((a,b)=>{
          const ap = /pt(-|_)BR/i.test(a.lang)?-1:1;
          const bp = /pt(-|_)BR/i.test(b.lang)?-1:1;
          return ap-bp || a.name.localeCompare(b.name);
        });
        sorted.forEach(v=>{
          const opt = document.createElement("option");
          opt.value = v.voiceURI;
          opt.textContent = `${v.name} (${v.lang})`;
          vozSelect.appendChild(opt);
        });
        // selecionar salvo
        if(state.vozURI){
          vozSelect.value = state.vozURI;
        }else{
          const prefer = sorted.find(v=>/pt(-|_)BR/i.test(v.lang));
          if(prefer) vozSelect.value = prefer.voiceURI;
        }
        // aplicar no estado
        state.vozURI = vozSelect.value || null;
      }
      fill();
      speechSynthesis.onvoiceschanged = fill;
      vozSelect.addEventListener("change", ()=>{
        state.vozURI = vozSelect.value || null;
        salvarPrefs();
      });
    }

    // ========= ATALHOS =========
    function atalhos(e){
      if(e.target.tagName==="INPUT"||e.target.tagName==="SELECT"||e.target.isContentEditable) return;
      if(e.code==="ArrowLeft"){ anterior(); }
      if(e.code==="ArrowRight"){ proxima(); }
      if(e.code==="Space"){ e.preventDefault(); tocarItemAtual(); }
      if(e.key==="a"||e.key==="A"){ const v=!faseAuto.checked; faseAuto.checked=v; v?startAuto():stopAuto(); salvarPrefs(); }
      if(e.key==="m"||e.key==="M"){ const v=!cfgMute.checked; cfgMute.checked=v; state.mute=v; salvarPrefs(); }
    }

    // ========= HELPERS =========
    function qs(s){ return document.querySelector(s); }
    function shuffle(arr){
      for(let i=arr.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]]=[arr[j],arr[i]];
      }
      return arr;
    }

    // ========= EXTRAS =========
    // Propaga configs globais sempre que entramos na fase
    function syncGlobaisParaFase(){
      faseAuto.checked = cfgAuto.checked;
      faseShuffle.checked = cfgShuffle.checked;
    }

    // Substitui mostrarTela de entrada na fase para sincronizar settings
    const _iniciarFase = iniciarFase;
    const _iniciarSilabas = iniciarSilabas;
    iniciarFase = function(nome){ syncGlobaisParaFase(); _iniciarFase(nome); };
    iniciarSilabas = function(qtd){ syncGlobaisParaFase(); _iniciarSilabas(qtd); };

  </script>
</body>
</html>
