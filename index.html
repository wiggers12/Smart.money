<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pixcom - Sorteio Pix</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-white text-gray-800 font-sans">

<!-- TELA PRINCIPAL -->
<section id="mainView" class="max-w-md mx-auto mt-10 p-6 bg-gray-100 rounded-lg shadow">
  <h1 class="text-2xl font-bold text-blue-600 mb-4 text-center">Pixcom - Sorteio Pix</h1>
  <p class="text-center text-sm mb-2 text-gray-600">Inscreva-se para concorrer a um Pix!</p>
  <p class="text-center font-semibold text-yellow-600 mb-2">Status: <span id="statusText">Carregando...</span></p>
  <p class="text-center text-sm mb-4 text-red-600">Encerramento em: <span id="encerramentoText">--/--/----</span></p>

  <input type="text" id="instagramHandle" class="border p-2 w-full rounded mb-2" placeholder="@seuInstagram" />
  <input type="text" id="pixKey" class="border p-2 w-full rounded mb-2" placeholder="Chave Pix" />
  <button id="registerButton" class="bg-blue-500 hover:bg-blue-600 text-white w-full py-2 rounded mb-2 font-bold">Quero Participar</button>
  <p id="confirmationMsg" class="hidden text-green-600 text-center text-sm mb-2">InscriÃ§Ã£o confirmada!</p>

  <ul id="participantsList" class="text-sm mb-2"></ul>
  <p id="loadingParticipants" class="text-center text-gray-400">Carregando participantes...</p>

  <p class="text-xs text-gray-500 mt-4">Seu ID: <span id="userIdDisplay"></span></p>
  <p class="text-center mt-2"><a href="#" id="adminLink" class="text-blue-500 text-sm underline">Acesso Admin</a></p>
</section>

<!-- TELA LOGIN -->
<section id="loginView" class="hidden max-w-md mx-auto mt-10 p-6 bg-gray-100 rounded-lg shadow">
  <h2 class="text-xl font-bold text-yellow-600 text-center mb-4">Login Admin</h2>
  <input type="email" id="adminEmail" class="border p-2 w-full rounded mb-2" placeholder="Email" />
  <input type="password" id="adminPassword" class="border p-2 w-full rounded mb-4" placeholder="Senha" />
  <div class="flex gap-2">
    <button id="loginButton" class="bg-yellow-500 text-white w-full py-2 rounded font-bold">Entrar</button>
    <button id="backButton" class="bg-gray-400 text-white w-full py-2 rounded font-bold">Voltar</button>
  </div>
</section>

<!-- TELA ADMIN -->
<section id="adminPanel" class="hidden max-w-2xl mx-auto mt-10 p-6 bg-gray-100 rounded-lg shadow">
  <h2 class="text-2xl font-bold text-blue-700 mb-4 text-center">Painel Admin</h2>
  <div class="flex flex-wrap gap-2 mb-4 justify-center">
    <button id="abrirBtn" class="bg-green-500 text-white px-4 py-2 rounded">ðŸ”“ Abrir Sorteio</button>
    <button id="encerrarBtn" class="bg-yellow-500 text-white px-4 py-2 rounded">ðŸ”’ Encerrar</button>
    <button id="sortearBtn" class="bg-purple-600 text-white px-4 py-2 rounded">ðŸŽ¯ Sortear</button>
    <button id="voltarBtn" class="bg-gray-500 text-white px-4 py-2 rounded">â¬… Voltar</button>
    <button id="logoutButton" class="bg-red-600 text-white px-4 py-2 rounded">Sair</button>
  </div>

  <label class="block text-sm text-gray-700 mt-4 mb-1">Definir data/hora de encerramento:</label>
  <input type="datetime-local" id="dataEncerramento" class="border p-2 rounded w-full max-w-xs mb-4" />
  <button id="definirPrazoBtn" class="bg-blue-600 text-white px-4 py-2 rounded mb-6">Salvar Prazo</button>

  <h3 class="text-lg font-bold text-green-700 mt-4 mb-2">Participantes</h3>
  <table class="w-full text-sm table-auto border text-left text-gray-700">
    <thead><tr><th>@ Instagram</th><th>Chave Pix</th></tr></thead>
    <tbody id="adminParticipantsList"></tbody>
  </table>

  <h3 class="text-lg font-bold text-yellow-700 mt-4">ðŸŽ‰ Ganhador</h3>
  <p id="ganhadorText">Nenhum ainda.</p>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDZ2jr8QhV2p4IgcN2x-_fKBv3yeH7mUQU",
  authDomain: "smart-5a1c5.firebaseapp.com",
  projectId: "smart-5a1c5",
  storageBucket: "smart-5a1c5.appspot.com",
  messagingSenderId: "138657213190",
  appId: "1:138657213190:web:1652d65b2d6b2d7aefcc87"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Views
const mainView = document.getElementById("mainView");
const loginView = document.getElementById("loginView");
const adminPanel = document.getElementById("adminPanel");

function showView(view) {
  [mainView, loginView, adminPanel].forEach(v => v.classList.add("hidden"));
  view.classList.remove("hidden");
}

document.getElementById("adminLink").onclick = e => {
  e.preventDefault();
  showView(loginView);
};
document.getElementById("backButton").onclick = () => showView(mainView);
document.getElementById("logoutButton").onclick = () => signOut(auth);
document.getElementById("voltarBtn").onclick = () => showView(mainView);

// UID
const userId = localStorage.getItem("userId") || Math.random().toString(36).substring(2, 10);
localStorage.setItem("userId", userId);
document.getElementById("userIdDisplay").textContent = userId;

// Login
document.getElementById("loginButton").onclick = async () => {
  const email = adminEmail.value;
  const senha = adminPassword.value;
  try {
    await signInWithEmailAndPassword(auth, email, senha);
  } catch (e) {
    alert("Erro: " + e.message);
  }
};

onAuthStateChanged(auth, async user => {
  if (user) {
    showView(adminPanel);
    carregarParticipantesAdmin();
    carregarGanhador();
    carregarEncerramento();
  } else {
    showView(mainView);
    verificarStatus();
    carregarEncerramento();
  }
});

document.getElementById("abrirBtn").onclick = () => updateDoc(doc(db, "sorteio", "status"), { ativo: true });
document.getElementById("encerrarBtn").onclick = () => updateDoc(doc(db, "sorteio", "status"), { ativo: false });
document.getElementById("definirPrazoBtn").onclick = () => {
  const data = document.getElementById("dataEncerramento").value;
  if (!data) return alert("Escolha uma data.");
  updateDoc(doc(db, "sorteio", "status"), { encerramento: data });
  alert("Encerramento salvo!");
};

document.getElementById("sortearBtn").onclick = async () => {
  const snap = await getDocs(collection(db, "participantes"));
  const lista = snap.docs;
  if (!lista.length) return alert("Sem participantes!");
  const ganhador = lista[Math.floor(Math.random() * lista.length)].data();
  await setDoc(doc(db, "sorteio", "ganhador"), ganhador);
  carregarGanhador();
  alert("Ganhador sorteado!");
};

document.getElementById("registerButton").onclick = async () => {
  const ativo = await verificarStatus();
  if (!ativo) return alert("InscriÃ§Ãµes encerradas.");
  const instagram = instagramHandle.value.trim();
  const pix = pixKey.value.trim();
  if (!instagram || !pix) return alert("Preencha os campos.");
  await setDoc(doc(db, "participantes", userId), {
    instagram, chavePix: pix, data: new Date().toISOString()
  });
  document.getElementById("confirmationMsg").classList.remove("hidden");
};

async function verificarStatus() {
  const snap = await getDoc(doc(db, "sorteio", "status"));
  const ativo = snap.exists() && snap.data().ativo === true;
  document.getElementById("statusText").textContent = ativo ? "InscriÃ§Ãµes Abertas" : "InscriÃ§Ãµes Encerradas";
  return ativo;
}

async function carregarEncerramento() {
  const snap = await getDoc(doc(db, "sorteio", "status"));
  const dado = snap.exists() ? snap.data().encerramento : null;
  const el = document.getElementById("encerramentoText");
  if (dado) {
    const hora = new Date(dado);
    el.textContent = hora.toLocaleString("pt-BR");
    iniciarRelogio(hora);
  } else {
    el.textContent = "NÃ£o definido.";
  }
}

function iniciarRelogio(dataEncerramento) {
  const interval = setInterval(async () => {
    const agora = new Date();
    if (agora >= dataEncerramento) {
      clearInterval(interval);
      await updateDoc(doc(db, "sorteio", "status"), { ativo: false });
      document.getElementById("statusText").textContent = "InscriÃ§Ãµes Encerradas";
    }
  }, 1000);
}

onSnapshot(collection(db, "participantes"), snap => {
  const ul = document.getElementById("participantsList");
  ul.innerHTML = "";
  snap.forEach(doc => {
    const li = document.createElement("li");
    li.textContent = doc.data().instagram;
    ul.appendChild(li);
  });
  document.getElementById("loadingParticipants").style.display = "none";
});

async function carregarParticipantesAdmin() {
  const snap = await getDocs(collection(db, "participantes"));
  const tbody = document.getElementById("adminParticipantsList");
  tbody.innerHTML = "";
  snap.forEach(doc => {
    const d = doc.data();
    tbody.innerHTML += `<tr><td>${d.instagram}</td><td>${d.chavePix}</td></tr>`;
  });
}

async function carregarGanhador() {
  const docSnap = await getDoc(doc(db, "sorteio", "ganhador"));
  if (docSnap.exists()) {
    const g = docSnap.data();
    document.getElementById("ganhadorText").textContent = `${g.instagram} (${g.chavePix})`;
  }
}
</script>
</body>
</html>