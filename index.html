<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pixcom - Sorteio Pix</title>
  <meta name="theme-color" content="#111827" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .input-field {
      background: #1f2937;
      color: white;
      padding: 10px;
      width: 100%;
      margin-bottom: 10px;
      border: 1px solid #374151;
      border-radius: 4px;
    }
    .btn {
      background: #3b82f6;
      color: white;
      padding: 10px;
      width: 100%;
      border-radius: 4px;
      font-weight: bold;
    }
  </style>
</head>
<body class="bg-gray-900 text-white font-sans">

<!-- VIEW PRINCIPAL -->
<section id="mainView">
  <div class="max-w-md mx-auto bg-gray-800 p-6 rounded-lg shadow mt-10 text-center">
    <h1 class="text-2xl font-bold text-pink-400 mb-4">Pixcom - Sorteio Pix Instagram!</h1>
    <p class="text-gray-300 mb-4">Inscreva-se para participar e ganhar um Pix!</p>
    <p class="mb-4 font-semibold">Status: <span class="text-yellow-400" id="statusText">Carregando...</span></p>
    <input type="text" id="instagramHandle" class="input-field" placeholder="@seuinstagram">
    <input type="text" id="pixKey" class="input-field" placeholder="Chave Pix">
    <button id="registerButton" class="btn">Quero Participar!</button>
    <div class="mt-6">
      <h2 class="text-xl font-bold text-green-400">Ganhador</h2>
      <p id="winnerDisplay" class="text-lg mt-2 text-yellow-300"></p>
    </div>
    <p class="text-sm text-gray-400 mt-2">Seu ID: <span id="userIdDisplay"></span></p>
    <a href="#" id="adminLink" class="text-blue-400 text-sm mt-2 inline-block">Acesso Admin</a>
  </div>
</section>

<!-- VIEW LOGIN -->
<section id="loginView" class="hidden">
  <div class="max-w-md mx-auto bg-gray-800 p-6 rounded-lg shadow mt-10">
    <h2 class="text-xl font-bold text-yellow-400 text-center mb-4">Login do Admin</h2>
    <input type="email" id="adminEmail" class="input-field" placeholder="Email">
    <input type="password" id="adminPassword" class="input-field" placeholder="Senha">
    <button id="loginButton" class="btn">Entrar</button>
  </div>
</section>

<!-- VIEW ADMIN -->
<section id="adminPanel" class="hidden">
  <div class="max-w-xl mx-auto bg-gray-800 p-6 rounded-lg shadow mt-10">
    <h2 class="text-2xl font-bold text-yellow-300 mb-4 text-center">Painel de Administração</h2>
    <div class="grid grid-cols-2 gap-2 mb-4">
      <button id="openDrawBtn" class="btn">Abrir Sorteio</button>
      <button id="closeDrawBtn" class="bg-red-600 btn">Encerrar Sorteio</button>
      <button id="drawWinnerBtn" class="bg-green-600 btn col-span-2">Sortear Ganhador</button>
      <button id="logoutButton" class="bg-gray-600 btn col-span-2">Sair</button>
    </div>
    <h3 class="text-lg font-bold text-green-300 mt-4 mb-2">Participantes</h3>
    <table class="w-full text-sm text-left text-gray-200">
      <thead>
        <tr><th>@ Instagram</th><th>Chave Pix</th></tr>
      </thead>
      <tbody id="adminParticipantsList"></tbody>
    </table>
  </div>
</section>

<!-- FIREBASE + APP -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBKlVI23YoxRb1fntQKy-ZfkzaDM-MWsSQ",
    authDomain: "doce-sabor-caseiro.firebaseapp.com",
    projectId: "doce-sabor-caseiro",
    storageBucket: "doce-sabor-caseiro.appspot.com",
    messagingSenderId: "414062499771",
    appId: "1:414062499771:web:1a811377bc6bbf145f969e"
  };

  const ADMIN_UID = "mv0x6ktWwfZHsIKotKnmrW9RQsY2";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const mainView = document.getElementById("mainView");
  const loginView = document.getElementById("loginView");
  const adminPanel = document.getElementById("adminPanel");

  const showView = (v) => {
    [mainView, loginView, adminPanel].forEach(el => el.classList.add("hidden"));
    v.classList.remove("hidden");
  };

  const userId = localStorage.getItem("userId") || crypto.randomUUID();
  localStorage.setItem("userId", userId);
  document.getElementById("userIdDisplay").textContent = userId;

  // Autenticação
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      if (user.uid === ADMIN_UID) {
        showView(adminPanel);
        carregarParticipantesAdmin();
      } else {
        showView(mainView);
      }
    } else {
      await signInAnonymously(auth);
    }
    atualizarStatus();
    mostrarGanhador();
  });

  document.getElementById("adminLink").onclick = (e) => {
    e.preventDefault();
    showView(loginView);
  };

  document.getElementById("loginButton").onclick = async () => {
    try {
      await signInWithEmailAndPassword(auth,
        document.getElementById("adminEmail").value,
        document.getElementById("adminPassword").value
      );
    } catch (e) {
      alert("Erro no login: " + e.message);
    }
  };

  document.getElementById("logoutButton").onclick = () => signOut(auth);

  // Inscrição
  document.getElementById("registerButton").onclick = async () => {
    const insta = document.getElementById("instagramHandle").value.trim();
    const chave = document.getElementById("pixKey").value.trim();
    const statusDoc = await getDoc(doc(db, "sorteio", "status"));
    if (!statusDoc.exists() || !statusDoc.data().aberto) {
      return alert("O sorteio está encerrado.");
    }
    if (!insta || !chave) return alert("Preencha todos os campos!");
    await setDoc(doc(db, "participantes", userId), {
      instagram: insta,
      chavePix: chave,
      data: new Date().toISOString()
    });
    alert("Inscrição confirmada!");
  };

  // Status
  async function atualizarStatus() {
    const statusDoc = await getDoc(doc(db, "sorteio", "status"));
    const aberto = statusDoc.exists() && statusDoc.data().aberto;
    document.getElementById("statusText").textContent = aberto ? "Inscrições Abertas" : "Encerradas";
  }

  // Admin: Abrir/Encerrar
  document.getElementById("openDrawBtn").onclick = async () => {
    await setDoc(doc(db, "sorteio", "status"), { aberto: true });
    alert("Sorteio aberto!");
  };
  document.getElementById("closeDrawBtn").onclick = async () => {
    await setDoc(doc(db, "sorteio", "status"), { aberto: false });
    alert("Sorteio encerrado!");
  };

  // Admin: Sortear
  document.getElementById("drawWinnerBtn").onclick = async () => {
    const snapshot = await getDocs(collection(db, "participantes"));
    const docs = snapshot.docs;
    if (!docs.length) return alert("Nenhum participante!");
    const sorteado = docs[Math.floor(Math.random() * docs.length)].data();
    await setDoc(doc(db, "sorteio", "ganhador"), sorteado);
    alert(`Ganhador sorteado: ${sorteado.instagram}`);
    mostrarGanhador();
  };

  // Exibir ganhador
  async function mostrarGanhador() {
    const docG = await getDoc(doc(db, "sorteio", "ganhador"));
    if (docG.exists()) {
      const g = docG.data();
      document.getElementById("winnerDisplay").textContent = `@${g.instagram} - ${g.chavePix}`;
    }
  }

  // Listagem
  function carregarParticipantesAdmin() {
    const tbody = document.getElementById("adminParticipantsList");
    onSnapshot(collection(db, "participantes"), (snapshot) => {
      tbody.innerHTML = "";
      snapshot.forEach(doc => {
        const d = doc.data();
        tbody.innerHTML += `<tr><td>${d.instagram}</td><td>${d.chavePix}</td></tr>`;
      });
    });
  }
</script>

</body>
</html>