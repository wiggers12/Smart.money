<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pixcom - Sorteio Pix</title>
  <meta name="theme-color" content="#111827" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .input-field {
      background: #1f2937;
      color: white;
      padding: 10px;
      width: 100%;
      margin-bottom: 10px;
      border: 1px solid #374151;
      border-radius: 4px;
    }
    .btn {
      background: #3b82f6;
      color: white;
      padding: 10px;
      width: 100%;
      border-radius: 4px;
      font-weight: bold;
    }
  </style>
</head>
<body class="bg-gray-900 text-white font-sans">

<!-- VISUAL PRINCIPAL -->
<section id="mainView">
  <div class="max-w-md mx-auto bg-gray-800 p-6 rounded-lg shadow mt-10 text-center">
    <h1 class="text-2xl font-bold text-pink-400 mb-4">Pixcom - Sorteio Pix Instagram!</h1>
    <p class="text-gray-300 mb-4">Inscreva-se para participar e ganhar um Pix!</p>
    <p class="mb-1 font-semibold">Status: <span class="text-yellow-400" id="statusText">Carregando...</span></p>
    <span id="timerCountdown" class="block text-sm text-green-300 mb-4"></span>
    <input type="text" id="instagramHandle" class="input-field" placeholder="@seuinstagram">
    <input type="text" id="pixKey" class="input-field" placeholder="Chave Pix">
    <button id="registerButton" class="btn">Quero Participar!</button>
    <h2 class="text-xl mt-6 mb-2 font-bold text-green-400">Participantes</h2>
    <ul id="participantsList" class="mb-2 hidden"></ul>
    <p id="loadingParticipants">Carregando participantes...</p>
    <p class="text-sm text-gray-400 mt-2">Seu ID: <span id="userIdDisplay"></span></p>
    <a href="#" id="adminLink" class="text-blue-400 text-sm mt-2 inline-block">Acesso Admin</a>
  </div>
</section>

<!-- LOGIN ADMIN -->
<section id="loginView" class="hidden">
  <div class="max-w-md mx-auto bg-gray-800 p-6 rounded-lg shadow mt-10">
    <h2 class="text-xl font-bold text-yellow-400 text-center mb-4">Login do Admin</h2>
    <input type="email" id="adminEmail" class="input-field" placeholder="Email">
    <input type="password" id="adminPassword" class="input-field" placeholder="Senha">
    <button id="loginButton" class="btn">Entrar</button>
  </div>
</section>

<!-- PAINEL ADMIN -->
<section id="adminPanel" class="hidden">
  <div class="max-w-xl mx-auto bg-gray-800 p-6 rounded-lg shadow mt-10">
    <h2 class="text-2xl font-bold text-yellow-300 mb-4 text-center">Painel de Administração</h2>

    <div class="flex flex-wrap gap-2 mb-4">
      <input type="number" id="minutosInput" class="input-field w-24" placeholder="Min">
      <button id="abrirBtn" class="btn w-full sm:w-auto">🔓 Abrir Sorteio</button>
      <button id="encerrarBtn" class="btn w-full sm:w-auto bg-yellow-500">🔒 Encerrar Sorteio</button>
      <button id="sortearBtn" class="btn w-full sm:w-auto bg-green-600">🎉 Sortear Ganhador</button>
      <button id="voltarBtn" class="btn w-full sm:w-auto bg-gray-600">← Voltar à Inscrição</button>
      <button id="logoutButton" class="btn w-full sm:w-auto bg-red-600">Sair</button>
    </div>

    <h3 class="text-lg font-bold text-green-300 mt-6 mb-2">Participantes</h3>
    <table class="w-full text-sm table-auto text-left text-gray-200">
      <thead><tr><th>@ Instagram</th><th>Chave Pix</th></tr></thead>
      <tbody id="adminParticipantsList"></tbody>
    </table>

    <h3 class="text-lg font-bold text-yellow-400 mt-6 mb-2">🎯 Ganhador</h3>
    <p id="ganhadorText" class="text-white">Nenhum ainda.</p>
  </div>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js";

// 🔐 Firebase config (substitua com seu projeto)
const firebaseConfig = {
  apiKey: "SUA_API_KEY",
  authDomain: "SEU_AUTH_DOMAIN",
  projectId: "SEU_PROJECT_ID",
  storageBucket: "SEU_BUCKET",
  messagingSenderId: "SEU_SENDER_ID",
  appId: "SEU_APP_ID"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const mainView = document.getElementById("mainView");
const loginView = document.getElementById("loginView");
const adminPanel = document.getElementById("adminPanel");

const showView = (v) => {
  [mainView, loginView, adminPanel].forEach(el => el.classList.add("hidden"));
  v.classList.remove("hidden");
};

// Navegação
document.getElementById("adminLink").onclick = e => {
  e.preventDefault();
  showView(loginView);
};
document.getElementById("voltarBtn").onclick = () => {
  showView(mainView);
};

// Login admin
document.getElementById("loginButton").onclick = async () => {
  const email = document.getElementById("adminEmail").value;
  const password = document.getElementById("adminPassword").value;
  try {
    await signInWithEmailAndPassword(auth, email, password);
  } catch (e) {
    alert("Erro: " + e.message);
  }
};
document.getElementById("logoutButton").onclick = () => signOut(auth);

// Autenticação
onAuthStateChanged(auth, async user => {
  if (user) {
    showView(adminPanel);
    carregarParticipantesAdmin();
    carregarGanhador();
  } else {
    showView(mainView);
  }
});

// ID persistente
const savedId = localStorage.getItem("userId") || Math.random().toString(36).substr(2, 9);
localStorage.setItem("userId", savedId);
document.getElementById("userIdDisplay").textContent = savedId;

// Status e contagem
async function verificarStatus() {
  const docSnap = await getDoc(doc(db, "sorteio", "status"));
  const status = docSnap.exists() && docSnap.data().ativo === true;
  document.getElementById("statusText").textContent = status ? "Inscrições Abertas" : "Inscrições Encerradas";
  if (docSnap.exists() && docSnap.data().encerramento) {
    atualizarContagem(docSnap.data().encerramento);
  }
  return status;
}
verificarStatus();

function atualizarContagem(encerramentoStr) {
  const countdownEl = document.getElementById("timerCountdown");
  const timer = setInterval(() => {
    const restante = new Date(encerramentoStr) - new Date();
    if (restante <= 0) {
      countdownEl.textContent = "⏰ Tempo encerrado";
      clearInterval(timer);
      return;
    }
    const min = Math.floor(restante / 60000);
    const seg = Math.floor((restante % 60000) / 1000);
    countdownEl.textContent = `⏳ Tempo restante: ${min}m ${seg}s`;
  }, 1000);
}

// Registro de participante
document.getElementById("registerButton").onclick = async () => {
  const status = await verificarStatus();
  if (!status) return alert("Inscrições encerradas.");
  const instagram = document.getElementById("instagramHandle").value.trim();
  const pix = document.getElementById("pixKey").value.trim();
  if (!instagram || !pix) return alert("Preencha os campos.");
  try {
    await setDoc(doc(db, "participantes", savedId), {
      instagram, chavePix: pix, data: new Date().toISOString()
    });
    alert("✅ Inscrição confirmada com sucesso!");
  } catch (e) {
    alert("Erro ao salvar: " + e.message);
  }
};

// Participantes em tempo real
onSnapshot(collection(db, "participantes"), snapshot => {
  const ul = document.getElementById("participantsList");
  const loading = document.getElementById("loadingParticipants");
  ul.innerHTML = "";
  snapshot.forEach(doc => {
    const li = document.createElement("li");
    li.textContent = doc.data().instagram;
    ul.appendChild(li);
  });
  ul.classList.remove("hidden");
  loading.style.display = "none";
});

// Funções admin
async function carregarParticipantesAdmin() {
  const snap = await getDocs(collection(db, "participantes"));
  const tbody = document.getElementById("adminParticipantsList");
  tbody.innerHTML = "";
  snap.forEach(doc => {
    const p = doc.data();
    tbody.innerHTML += `<tr><td>${p.instagram}</td><td>${p.chavePix}</td></tr>`;
  });
}
async function carregarGanhador() {
  const docSnap = await getDoc(doc(db, "sorteio", "ganhador"));
  if (docSnap.exists()) {
    const d = docSnap.data();
    document.getElementById("ganhadorText").textContent = `${d.instagram} (${d.chavePix})`;
  }
}

// Ações dos botões admin
document.getElementById("abrirBtn").onclick = async () => {
  const minutos = parseInt(document.getElementById("minutosInput").value || "0");
  const encerramento = new Date(Date.now() + minutos * 60000);
  await updateDoc(doc(db, "sorteio", "status"), {
    ativo: true,
    encerramento: encerramento.toISOString()
  });
  alert(`Sorteio aberto por ${minutos} minutos!`);
  verificarStatus();
};

document.getElementById("encerrarBtn").onclick = async () => {
  await updateDoc(doc(db, "sorteio", "status"), { ativo: false });
  alert("Sorteio encerrado!");
  verificarStatus();
};

document.getElementById("sortearBtn").onclick = async () => {
  const snap = await getDocs(collection(db, "participantes"));
  const docs = snap.docs;
  if (docs.length === 0) return alert("Nenhum participante.");
  const escolhido = docs[Math.floor(Math.random() * docs.length)].data();
  await setDoc(doc(db, "sorteio", "ganhador"), escolhido);
  alert("🎉 Ganhador sorteado!");
  carregarGanhador();
};
</script>
</body>
</html>